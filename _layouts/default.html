<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if page.title %}{{ page.title }} - {% endif %}CFL Wiki</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Caprasimo&family=Chonburi&family=DM+Serif+Display&family=Abril+Fatface&family=Bricolage+Grotesque:wght@400;600;700&family=Calistoga&family=Varela+Round&family=Fredoka:wght@400;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    {% include marquee.html %}

    <header>
        <h1><a href="/">CFL Wiki</a></h1>
        <nav>
            {% include nav.html type="main" %}
        </nav>
    </header>

    <main>
        {{ content }}
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-social">
                <a href="https://github.com/ChicoFabLab" class="social-link" title="GitHub" target="_blank" rel="noopener">
                    ‚åò
                </a>
                <a href="https://discord.gg/chicofablab" class="social-link" title="Discord" target="_blank" rel="noopener">
                    üí¨
                </a>
            </div>
            <div class="footer-links">
                {% include nav.html type="footer" %}
            </div>
            <p>Chico Fab Lab ¬∑ 603 Orange Street ¬∑ Chico, CA</p>
            <p>Open Wednesdays 5-7pm and by arrangement</p>
            <span class="footer-badge">Built with Jekyll ¬∑ Hosted on GitHub Pages</span>
        </div>
    </footer>

    <div class="cfl-settings" id="cfl-settings" aria-live="polite">
        <div class="cfl-settings__scrim" data-scrim hidden></div>
        <button type="button" class="cfl-settings__fab" aria-expanded="false" aria-controls="cfl-settings-panel">
            <span class="cfl-settings__fab-icon" aria-hidden="true">‚öôÔ∏è</span>
            <span class="cfl-settings__fab-label">Site settings</span>
        </button>
        <div class="cfl-settings__orbit" aria-hidden="true">
            <button type="button" class="cfl-settings__orbit-btn" data-panel="fonts" title="Fonts">
                <span aria-hidden="true">Aa</span>
                <span class="sr-only">Fonts</span>
            </button>
            <button type="button" class="cfl-settings__orbit-btn" data-panel="colors" title="Colors">
                <span aria-hidden="true">üé®</span>
                <span class="sr-only">Colors</span>
            </button>
            <button type="button" class="cfl-settings__orbit-btn" data-action="quick-font" data-font="fraunces" title="Soft serif">
                <span aria-hidden="true">ü´ß</span>
                <span class="sr-only">Soft serif</span>
            </button>
            <button type="button" class="cfl-settings__orbit-btn" data-action="quick-font" data-font="bricolage" title="Playful sans">
                <span aria-hidden="true">‚ú®</span>
                <span class="sr-only">Playful sans</span>
            </button>
            <button type="button" class="cfl-settings__orbit-btn" data-panel="scope" title="Scope">
                <span aria-hidden="true">üåê</span>
                <span class="sr-only">Scope</span>
            </button>
            <button type="button" class="cfl-settings__orbit-btn" data-panel="reset" title="Reset">
                <span aria-hidden="true">‚Ü∫</span>
                <span class="sr-only">Reset</span>
            </button>
        </div>

        <div class="cfl-settings__panel" id="cfl-settings-panel" data-panel="fonts" hidden>
            <div class="cfl-settings__panel-title">Font switcher</div>
            <label class="cfl-settings__label" for="cfl-font-select">Pick a style</label>
            <select id="cfl-font-select" class="cfl-settings__select">
                <option value="default">Default (Georgia + Inter)</option>
                <option value="fraunces">Fraunces (soft serif)</option>
                <option value="caprasimo">Caprasimo (bold & bubbly)</option>
                <option value="chonburi">Chonburi (retro serif)</option>
                <option value="dm-serif">DM Serif Display (editorial)</option>
                <option value="abril">Abril Fatface (dramatic)</option>
                <option value="bricolage">Bricolage Grotesque (playful sans)</option>
                <option value="calistoga">Calistoga (friendly retro)</option>
                <option value="varela">Varela Round (soft sans)</option>
                <option value="fredoka">Fredoka (bold rounded)</option>
                <option value="nunito">Nunito (rounded UI)</option>
            </select>
            <p class="cfl-settings__note">Headings and body will update instantly. Defaults remain Georgia/Inter if you reset.</p>
        </div>

        <div class="cfl-settings__panel" data-panel="colors" hidden>
            <div class="cfl-settings__panel-title">Color theme</div>
            <p class="cfl-settings__note">Pick an accent vibe. Applies to this device only.</p>
            <div class="cfl-settings__swatches" role="group" aria-label="Color themes">
                <button type="button" class="cfl-settings__swatch" data-theme="default">
                    <span class="cfl-settings__swatch-dot" style="--swatch-accent: #e63946; --swatch-bg: #fef9f3;"></span>
                    Default
                </button>
                <button type="button" class="cfl-settings__swatch" data-theme="teal">
                    <span class="cfl-settings__swatch-dot" style="--swatch-accent: #0f766e; --swatch-bg: #f0fdfa;"></span>
                    Teal
                </button>
                <button type="button" class="cfl-settings__swatch" data-theme="amber">
                    <span class="cfl-settings__swatch-dot" style="--swatch-accent: #d97706; --swatch-bg: #fffbeb;"></span>
                    Amber
                </button>
                <button type="button" class="cfl-settings__swatch" data-theme="plum">
                    <span class="cfl-settings__swatch-dot" style="--swatch-accent: #9333ea; --swatch-bg: #f5f3ff;"></span>
                    Plum
                </button>
            </div>
            <div class="cfl-settings__legal">Colors are applied with CSS variables only; nothing is sent or stored remotely.</div>
        </div>

        <div class="cfl-settings__panel" data-panel="scope" hidden>
            <div class="cfl-settings__panel-title">Scope</div>
            <label class="cfl-settings__label">Apply where?</label>
            <label class="cfl-toggle cfl-toggle--md cfl-settings__scope-toggle">
                <input type="checkbox" class="cfl-toggle__input" id="cfl-settings-scope">
                <span class="cfl-toggle__track">
                    <span class="cfl-toggle__thumb"></span>
                </span>
                <span class="cfl-toggle__label">Site-wide (this device)</span>
            </label>
            <p class="cfl-settings__note">Switch off for ‚ÄúThis page only‚Äù (clears when you leave). Switch on for ‚ÄúSite-wide‚Äù (saves to this browser only).</p>
            <div class="cfl-settings__legal">Settings stay local on your device (localStorage/sessionStorage). Fonts load from Google Fonts. No tracking or cookies.</div>
        </div>

        <div class="cfl-settings__panel" data-panel="reset" hidden>
            <div class="cfl-settings__panel-title">Reset & debug</div>
            <button type="button" class="cfl-btn cfl-btn--ghost cfl-btn--sm cfl-settings__reset" data-action="reset-scope">Reset current scope</button>
            <label class="cfl-toggle cfl-toggle--sm cfl-settings__debug-toggle">
                <input type="checkbox" class="cfl-toggle__input" id="cfl-settings-debug" checked>
                <span class="cfl-toggle__track">
                    <span class="cfl-toggle__thumb"></span>
                </span>
                <span class="cfl-toggle__label">Debug logging</span>
            </label>
            <p class="cfl-settings__note">Debug logs print to the console to help troubleshoot font changes and persistence.</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add copy buttons to code snippets
        var copyIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
        var checkIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';

        document.querySelectorAll('.code-snippet__content').forEach(function(content) {
            var code = content.querySelector('code');
            if (code && !content.querySelector('.code-snippet__copy')) {
                var btn = document.createElement('button');
                btn.className = 'code-snippet__copy';
                btn.innerHTML = copyIcon + ' Copy';
                content.appendChild(btn);

                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navigator.clipboard.writeText(code.textContent.trim()).then(function() {
                        btn.classList.add('code-snippet__copy--copied');
                        btn.innerHTML = checkIcon + ' Copied';
                        setTimeout(function() {
                            btn.classList.remove('code-snippet__copy--copied');
                            btn.innerHTML = copyIcon + ' Copy';
                        }, 2000);
                    });
                });
            }
        });

        // Search clear button functionality
        document.querySelectorAll('.cfl-search__clear').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var input = this.parentElement.querySelector('.cfl-search__input');
                if (input) {
                    input.value = '';
                    input.focus();
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        });

        // Tabs functionality
        document.querySelectorAll('.cfl-tabs').forEach(function(tabContainer) {
            var tabs = tabContainer.querySelectorAll('.cfl-tabs__tab');
            tabs.forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var targetId = this.getAttribute('data-tab');

                    // Deactivate all tabs and panels
                    tabContainer.querySelectorAll('.cfl-tabs__tab').forEach(function(t) {
                        t.classList.remove('cfl-tabs__tab--active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    tabContainer.querySelectorAll('.cfl-tabs__panel').forEach(function(p) {
                        p.classList.remove('cfl-tabs__panel--active');
                        p.setAttribute('hidden', '');
                    });

                    // Activate clicked tab and its panel
                    this.classList.add('cfl-tabs__tab--active');
                    this.setAttribute('aria-selected', 'true');
                    var panel = tabContainer.querySelector('[data-panel="' + targetId + '"]');
                    if (panel) {
                        panel.classList.add('cfl-tabs__panel--active');
                        panel.removeAttribute('hidden');
                    }
                });
            });
        });

        // Toast notification system
        window.CFL = window.CFL || {};

        // Create toast container if it doesn't exist
        if (!document.querySelector('.cfl-toast-container')) {
            var container = document.createElement('div');
            container.className = 'cfl-toast-container';
            document.body.appendChild(container);
        }

        // Toast function
        window.CFL.toast = function(options) {
            var container = document.querySelector('.cfl-toast-container');
            var toast = document.createElement('div');
            toast.className = 'cfl-toast cfl-toast--' + (options.variant || 'info');

            var iconAnim = options.iconAnim || 'pop';
            toast.innerHTML =
                '<span class="cfl-toast__icon cfl-toast__icon--' + iconAnim + '">' + (options.icon || '‚ú®') + '</span>' +
                '<div class="cfl-toast__content">' +
                    '<div class="cfl-toast__title">' + (options.title || 'Notification') + '</div>' +
                    '<div class="cfl-toast__message">' + (options.message || '') + '</div>' +
                '</div>';

            container.appendChild(toast);

            // Auto remove after duration
            setTimeout(function() {
                toast.classList.add('cfl-toast--leaving');
                setTimeout(function() {
                    toast.remove();
                }, 300);
            }, options.duration || 3000);
        };

        // Fun toast presets
        window.CFL.toasts = {
            primary: function() {
                CFL.toast({ icon: 'üöÄ', title: 'Blast off!', message: 'Primary action initiated. Ready for launch!', variant: 'info', iconAnim: 'bounce' });
            },
            secondary: function() {
                CFL.toast({ icon: 'üé≠', title: 'Behind the scenes', message: 'Secondary actions are the unsung heroes.', variant: 'info', iconAnim: 'pop' });
            },
            ghost: function() {
                CFL.toast({ icon: 'üëª', title: 'Boo!', message: 'Ghost buttons are spooky subtle.', variant: 'info', iconAnim: 'shake' });
            },
            danger: function() {
                CFL.toast({ icon: 'üî•', title: 'Danger zone!', message: 'Handle with care. This is serious business.', variant: 'danger', iconAnim: 'shake' });
            },
            success: function() {
                CFL.toast({ icon: 'üéâ', title: 'Woohoo!', message: 'Everything worked perfectly!', variant: 'success', iconAnim: 'bounce' });
            },
            small: function() {
                CFL.toast({ icon: 'üêú', title: 'Small but mighty!', message: 'Size doesn\'t matter, impact does.', variant: 'info', iconAnim: 'pop' });
            },
            medium: function() {
                CFL.toast({ icon: 'üéØ', title: 'Right on target!', message: 'The Goldilocks zone of buttons.', variant: 'info', iconAnim: 'pop' });
            },
            large: function() {
                CFL.toast({ icon: 'ü¶ñ', title: 'Go big!', message: 'Large and in charge. No squinting required!', variant: 'info', iconAnim: 'bounce' });
            },
            rocket: function() {
                CFL.toast({ icon: 'üöÄ', title: '3... 2... 1... Liftoff!', message: 'Houston, we have ignition!', variant: 'party', iconAnim: 'bounce' });
            },
            pizza: function() {
                CFL.toast({ icon: 'üçï', title: 'Pizza time!', message: 'You deserve a slice. Great work!', variant: 'warning', iconAnim: 'spin' });
            },
            unicorn: function() {
                CFL.toast({ icon: 'ü¶Ñ', title: 'Magical!', message: 'Unicorns approve of this action.', variant: 'party', iconAnim: 'bounce' });
            },
            coffee: function() {
                CFL.toast({ icon: '‚òï', title: 'Coffee break!', message: 'Refueling creativity levels...', variant: 'warning', iconAnim: 'pop' });
            },
            sparkles: function() {
                CFL.toast({ icon: '‚ú®', title: 'Sparkle sparkle!', message: 'Adding a little magic to your day.', variant: 'party', iconAnim: 'spin' });
            },
            music: function() {
                CFL.toast({ icon: 'üéµ', title: 'Feel the beat!', message: 'Dancing through the code...', variant: 'info', iconAnim: 'bounce' });
            },
            brain: function() {
                CFL.toast({ icon: 'üß†', title: 'Big brain time!', message: '200 IQ play detected.', variant: 'success', iconAnim: 'pop' });
            },
            fire: function() {
                CFL.toast({ icon: 'üî•', title: 'This is fire!', message: 'Absolutely blazing performance!', variant: 'danger', iconAnim: 'shake' });
            },
            party: function() {
                CFL.toast({ icon: 'üéä', title: 'Party mode!', message: 'Let\'s celebrate! Confetti everywhere!', variant: 'party', iconAnim: 'bounce' });
            },
            robot: function() {
                CFL.toast({ icon: 'ü§ñ', title: 'Beep boop!', message: 'Automation activated. Humans optional.', variant: 'info', iconAnim: 'shake' });
            },
            heart: function() {
                CFL.toast({ icon: '‚ù§Ô∏è', title: 'Sending love!', message: 'You\'re doing amazing!', variant: 'danger', iconAnim: 'pop' });
            },
            lightning: function() {
                CFL.toast({ icon: '‚ö°', title: 'Lightning fast!', message: 'Speed is your superpower!', variant: 'warning', iconAnim: 'shake' });
            },
            cat: function() {
                CFL.toast({ icon: 'üê±', title: 'Meow!', message: 'Cats approve. That\'s the highest honor.', variant: 'info', iconAnim: 'bounce' });
            },
            dog: function() {
                CFL.toast({ icon: 'üêï', title: 'Good human!', message: 'Tail wagging intensifies!', variant: 'success', iconAnim: 'shake' });
            }
        };

        // Slider value display
        document.querySelectorAll('.cfl-slider__input').forEach(function(slider) {
            var valueDisplay = slider.closest('.cfl-slider__wrapper')?.querySelector('.cfl-slider__value');
            if (valueDisplay) {
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                });
            }
        });

        // Segmented control switching
        document.querySelectorAll('.cfl-segmented').forEach(function(segmented) {
            segmented.querySelectorAll('.cfl-segmented__btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    segmented.querySelectorAll('.cfl-segmented__btn').forEach(function(b) {
                        b.classList.remove('cfl-segmented__btn--active');
                    });
                    this.classList.add('cfl-segmented__btn--active');
                });
            });
        });

        // Rating stars interaction
        document.querySelectorAll('.cfl-rating').forEach(function(rating) {
            var stars = rating.querySelectorAll('.cfl-rating__star');
            stars.forEach(function(star, index) {
                star.addEventListener('click', function() {
                    stars.forEach(function(s, i) {
                        if (i <= index) {
                            s.classList.add('cfl-rating__star--filled');
                        } else {
                            s.classList.remove('cfl-rating__star--filled');
                        }
                    });
                });
            });
        });

        // Color picker value display
        document.querySelectorAll('.cfl-color-picker__input').forEach(function(picker) {
            var valueDisplay = picker.closest('.cfl-color-picker')?.querySelector('.cfl-color-picker__value');
            if (valueDisplay) {
                picker.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                });
            }
        });

        // File upload drag and drop
        document.querySelectorAll('.cfl-upload').forEach(function(upload) {
            upload.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('cfl-upload--dragover');
            });
            upload.addEventListener('dragleave', function() {
                this.classList.remove('cfl-upload--dragover');
            });
            upload.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('cfl-upload--dragover');
                var files = e.dataTransfer.files;
                if (files.length) {
                    CFL.toast({ icon: 'üìÅ', title: 'Files received!', message: files.length + ' file(s) dropped', variant: 'success', iconAnim: 'bounce' });
                }
            });
        });

        // Floating settings widget (font switcher + scope)
        (function initSettingsWidget() {
            var settings = document.getElementById('cfl-settings');
            if (!settings) return;

            var fab = settings.querySelector('.cfl-settings__fab');
            var orbitButtons = settings.querySelectorAll('.cfl-settings__orbit-btn');
            var panels = settings.querySelectorAll('.cfl-settings__panel');
            var fontSelect = document.getElementById('cfl-font-select');
            var scopeToggle = document.getElementById('cfl-settings-scope');
            var debugToggle = document.getElementById('cfl-settings-debug');
            var resetButton = settings.querySelector('[data-action="reset-scope"]');
            var scrim = settings.querySelector('[data-scrim]');
            var swatches = settings.querySelectorAll('.cfl-settings__swatch');

            var STATE_KEYS = {
                scope: 'cflSettingsScope',
                site: 'cflSettingsSite',
                pagePrefix: 'cflSettingsPage:'
            };

            var fonts = {
                default: { heading: "'Georgia', 'Times New Roman', serif", body: "'Georgia', 'Times New Roman', serif", ui: "'Inter', system-ui, sans-serif" },
                fraunces: { heading: "'Fraunces', serif", body: "'Fraunces', serif", ui: "'Varela Round', 'Inter', system-ui, sans-serif" },
                caprasimo: { heading: "'Caprasimo', serif", body: "'Caprasimo', serif", ui: "'Nunito', system-ui, sans-serif" },
                chonburi: { heading: "'Chonburi', serif", body: "'Chonburi', serif", ui: "'Varela Round', 'Inter', system-ui, sans-serif" },
                'dm-serif': { heading: "'DM Serif Display', serif", body: "'DM Serif Display', serif", ui: "'Nunito', system-ui, sans-serif" },
                abril: { heading: "'Abril Fatface', serif", body: "'Abril Fatface', serif", ui: "'Nunito', system-ui, sans-serif" },
                bricolage: { heading: "'Bricolage Grotesque', 'Inter', system-ui, sans-serif", body: "'Bricolage Grotesque', 'Inter', system-ui, sans-serif", ui: "'Bricolage Grotesque', 'Inter', system-ui, sans-serif" },
                calistoga: { heading: "'Calistoga', serif", body: "'Calistoga', serif", ui: "'Nunito', system-ui, sans-serif" },
                varela: { heading: "'Varela Round', 'Inter', system-ui, sans-serif", body: "'Varela Round', 'Inter', system-ui, sans-serif", ui: "'Varela Round', 'Inter', system-ui, sans-serif" },
                fredoka: { heading: "'Fredoka', 'Nunito', system-ui, sans-serif", body: "'Fredoka', 'Nunito', system-ui, sans-serif", ui: "'Fredoka', 'Nunito', system-ui, sans-serif" },
                nunito: { heading: "'Nunito', system-ui, sans-serif", body: "'Nunito', system-ui, sans-serif", ui: "'Nunito', system-ui, sans-serif" }
            };

            var themes = {
                default: {},
                teal: {
                    '--accent': '#0f766e',
                    '--accent-hover': '#115e59',
                    '--accent-secondary': '#0ea5e9',
                    '--accent-secondary-hover': '#0284c7'
                },
                amber: {
                    '--accent': '#d97706',
                    '--accent-hover': '#b45309',
                    '--accent-secondary': '#f59e0b',
                    '--accent-secondary-hover': '#d97706'
                },
                plum: {
                    '--accent': '#9333ea',
                    '--accent-hover': '#7e22ce',
                    '--accent-secondary': '#22c55e',
                    '--accent-secondary-hover': '#16a34a'
                }
            };

            var state = {
                scope: 'site',
                font: 'default',
                theme: 'default',
                debug: true,
                openPanel: null
            };

            function logger() {
                if (!state.debug) return;
                var args = Array.prototype.slice.call(arguments);
                args.unshift('[CFL settings]');
                console.info.apply(console, args);
            }

            function storageForScope(scope) {
                return scope === 'site' ? localStorage : sessionStorage;
            }

            function scopeKey(scope) {
                return scope === 'site' ? STATE_KEYS.site : STATE_KEYS.pagePrefix + window.location.pathname;
            }

            function readScopePreference() {
                var savedScope = localStorage.getItem(STATE_KEYS.scope);
                if (savedScope === 'page' || savedScope === 'site') {
                    state.scope = savedScope;
                }
                if (scopeToggle) {
                    scopeToggle.checked = state.scope === 'site';
                }
            }

            function readDebugPreference() {
                var saved = localStorage.getItem('cflSettingsDebug');
                state.debug = saved === null ? true : saved !== 'false';
                if (debugToggle) debugToggle.checked = state.debug;
            }

            function readFontPreference() {
                var storage = storageForScope(state.scope);
                var key = scopeKey(state.scope);
                var stored = null;
                try {
                    stored = JSON.parse(storage.getItem(key));
                } catch (e) {
                    logger('Could not parse stored settings', e);
                }
                state.font = stored && stored.font && fonts[stored.font] ? stored.font : 'default';
                state.theme = stored && stored.theme && themes[stored.theme] ? stored.theme : 'default';
                if (fontSelect) fontSelect.value = state.font;
            }

            function applyFont() {
                var chosen = fonts[state.font] || fonts.default;
                var root = document.documentElement;
                root.style.setProperty('--font-heading', chosen.heading);
                root.style.setProperty('--font-body', chosen.body);
                root.style.setProperty('--font-ui', chosen.ui);
                logger('Applied font', state.font, 'scope', state.scope);
            }

            function updateActiveSwatch() {
                swatches.forEach(function(swatch) {
                    var t = swatch.getAttribute('data-theme');
                    swatch.classList.toggle('is-active', t === state.theme);
                });
            }

            function applyTheme() {
                var root = document.documentElement;
                // Reset to defaults first
                root.style.removeProperty('--accent');
                root.style.removeProperty('--accent-hover');
                root.style.removeProperty('--accent-secondary');
                root.style.removeProperty('--accent-secondary-hover');
                var chosen = themes[state.theme] || themes.default;
                Object.keys(chosen).forEach(function(key) {
                    root.style.setProperty(key, chosen[key]);
                });
                updateActiveSwatch();
                logger('Applied theme', state.theme, 'scope', state.scope);
            }

            function persist() {
                var storage = storageForScope(state.scope);
                var key = scopeKey(state.scope);
                storage.setItem(key, JSON.stringify({ font: state.font, theme: state.theme }));
                localStorage.setItem(STATE_KEYS.scope, state.scope);
                logger('Persisted settings', { scope: state.scope, font: state.font, theme: state.theme });
            }

            function resetCurrentScope() {
                var storage = storageForScope(state.scope);
                storage.removeItem(scopeKey(state.scope));
                state.font = 'default';
                state.theme = 'default';
                if (fontSelect) fontSelect.value = state.font;
                applyFont();
                applyTheme();
                persist();
                logger('Reset settings for scope', state.scope);
            }

            function openOrbitOnly() {
                state.openPanel = null;
                settings.classList.add('cfl-settings--open');
                fab.setAttribute('aria-expanded', 'true');
                panels.forEach(function(panel) { panel.setAttribute('hidden', ''); });
                settings.removeAttribute('data-open-panel');
                if (scrim) scrim.setAttribute('hidden', '');
            }

            function openPanel(panelId) {
                state.openPanel = panelId;
                settings.classList.add('cfl-settings--open');
                fab.setAttribute('aria-expanded', 'true');
                panels.forEach(function(panel) {
                    var active = panel.getAttribute('data-panel') === panelId;
                    panel.toggleAttribute('hidden', !active);
                });
                settings.setAttribute('data-open-panel', panelId);
                if (scrim) scrim.removeAttribute('hidden');
            }

            function closePanels() {
                state.openPanel = null;
                settings.classList.remove('cfl-settings--open');
                fab.setAttribute('aria-expanded', 'false');
                panels.forEach(function(panel) {
                    panel.setAttribute('hidden', '');
                });
                settings.removeAttribute('data-open-panel');
                if (scrim) scrim.setAttribute('hidden', '');
            }

            function togglePanels(panelId) {
                if (state.openPanel === panelId) {
                    closePanels();
                } else {
                    openPanel(panelId);
                }
            }

            // Event wiring
            if (fab) {
                fab.addEventListener('click', function() {
                    if (settings.classList.contains('cfl-settings--open') && !state.openPanel) {
                        closePanels();
                    } else if (settings.classList.contains('cfl-settings--open') && state.openPanel) {
                        openOrbitOnly();
                    } else {
                        openOrbitOnly();
                    }
                });
            }

            function positionOrbitButtons() {
                if (!orbitButtons.length) return;
                var radius = 110;
                var startDeg = -10;
                var endDeg = -170;
                var steps = orbitButtons.length > 1 ? orbitButtons.length - 1 : 1;
                orbitButtons.forEach(function(btn, index) {
                    var angleDeg = startDeg + ((endDeg - startDeg) * (index / steps));
                    var angleRad = angleDeg * (Math.PI / 180);
                    var tx = Math.cos(angleRad) * radius;
                    var ty = Math.sin(angleRad) * radius;
                    btn.style.setProperty('--tx', tx.toFixed(2) + 'px');
                    btn.style.setProperty('--ty', ty.toFixed(2) + 'px');
                });
            }

            positionOrbitButtons();

            orbitButtons.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    var panelId = e.currentTarget.getAttribute('data-panel');
                    var action = e.currentTarget.getAttribute('data-action');

                    if (action === 'quick-font') {
                        var quickFont = e.currentTarget.getAttribute('data-font');
                        if (fonts[quickFont]) {
                            state.font = quickFont;
                            if (fontSelect) fontSelect.value = quickFont;
                            applyFont();
                            persist();
                            logger('Quick font applied from orbit', quickFont);
                        }
                        return;
                    }

                    if (panelId) {
                        openPanel(panelId);
                    }
                });
            });

            if (fontSelect) {
                fontSelect.addEventListener('change', function(e) {
                    state.font = e.target.value;
                    applyFont();
                    applyTheme();
                    persist();
                });
            }

            if (scopeToggle) {
                scopeToggle.addEventListener('change', function(e) {
                    state.scope = e.target.checked ? 'site' : 'page';
                    readFontPreference();
                    applyFont();
                    applyTheme();
                    persist();
                });
            }

            if (debugToggle) {
                debugToggle.addEventListener('change', function(e) {
                    state.debug = e.target.checked;
                    localStorage.setItem('cflSettingsDebug', state.debug ? 'true' : 'false');
                    if (state.debug) {
                        logger('Debug logging enabled');
                    } else {
                        console.info('[CFL settings] Debug logging disabled');
                    }
                });
            }

            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    resetCurrentScope();
                });
            }

            if (scrim) {
                scrim.addEventListener('click', function() {
                    closePanels();
                });
            }

            swatches.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    var theme = e.currentTarget.getAttribute('data-theme');
                    if (themes[theme]) {
                        state.theme = theme;
                        swatches.forEach(function(s) { s.classList.toggle('is-active', s === btn); });
                        applyTheme();
                        persist();
                        logger('Theme changed', theme);
                    }
                });
            });

            document.addEventListener('click', function(event) {
                if (!settings.contains(event.target)) {
                    closePanels();
                }
            });

            document.addEventListener('keyup', function(event) {
                if (event.key === 'Escape') {
                    closePanels();
                }
            });

            window.addEventListener('pagehide', function() {
                sessionStorage.removeItem(scopeKey('page'));
            });

            // Init
            readScopePreference();
            readDebugPreference();
            readFontPreference();
            applyFont();
            applyTheme();
            persist();
            logger('Settings widget initialized', state);
        })();
    });
    </script>
</body>
</html>
